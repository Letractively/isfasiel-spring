<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="jbo">
	<typeAlias alias="hashMap" type="java.util.HashMap"/>
	
	<select id="jobDAO.list" resultClass="hashMap">
		SELECT * FROM ( 
			SELECT A.*, ROWNUM RNUM FROM (
				SELECT 
					C.CONTENT_ID 
					,	C.TITLE 
					,	U.USER_EMAIL 
					,	C.VIEW_COUNT 
					,	C.CONTENT_TYPE
					,	(SELECT COUNT(*) 
							FROM TN_CNT_CMT CM 
							WHERE	
									CM.CONTENT_ID = C.CONTENT_ID 
								AND	CM.DEL_YN = 'N'
								AND	CM.STATE = 0)
						 AS CMT_COUNT
				FROM TN_CONTENT C, TN_USER_INFO U, TN_JOB J
				WHERE	J.CONTENT_ID = C.CONTENT_ID
						AND U.USER_IDX = C.USER_IDX
						AND C.DEL_YN = 'N'
					<isNotEmpty property="title" close="" open="" prepend="AND"> 
						TITLE LIKE '%' || #title# || '%' 
					</isNotEmpty>
					<isNotEmpty property="userEmail" close="" open="" prepend="AND"> 
						U.USER_EMAIL LIKE '%' || #userEmail# || '%' 
					</isNotEmpty>
					<isNotEmpty property="posMaxX" close="" open="" prepend="AND"> 
						J.POS_X &lt;= #posMaxX# AND J.POS_X &gt;= #posMinX#   
					</isNotEmpty>
					<isNotEmpty property="posMaxY" close="" open="" prepend="AND"> 
						J.POS_Y &lt;= #posMaxY# AND J.POS_Y &gt;= #posMinY#   
					</isNotEmpty>
					<isNotEmpty property="suburb" close="" open="" prepend="AND"> 
						 J.SUBURB LIKE '%' || #suburb# || '%'
					</isNotEmpty>
					<isNotEmpty property="pay" close="" open="" prepend="AND"> 
						 J.PAY <![CDATA[<=]]> (#pay# + #payTerm#) AND
						 J.PAY <![CDATA[>=]]> (#pay# - #payTerm#)
					</isNotEmpty>
					<isNotEmpty property="addr" close="" open="" prepend="AND"> 
						 J.ADDR LIKE '%' || #addr# || '%'
					</isNotEmpty>
					<isNotEmpty property="jobType" close="" open="" prepend="AND"> 
						 J.JOB_TYPE = #jobType#
					</isNotEmpty>
					<isNotEmpty property="adType" close="" open="" prepend="AND"> 
						 J.AD_TYPE = #adType#
					</isNotEmpty>
				ORDER BY C.CONTENT_ID DESC
			) A WHERE ROWNUM 
			<![CDATA[<=]]> #lastIndex# ) WHERE RNUM <![CDATA[>=]]> #firstIndex# 
	</select>
	<insert id="jobDAO.insert">
		INSERT INTO TN_JOB (
			CONTENT_ID,
			BODY,
			POS_X,
			POS_Y,
			SUBURB,
			PAY, 
			ADDR, 
			DUE_DATE, 
			JOB_TYPE, 
			AD_TYPE 
			) 
		VALUES ( 
			#contentId#,
			#body#,
			#posX#,
			#posY#,
			#suburb#,
			#pay#,
			#addr#,
			#dueDate#,
			#jobType#,
			#adType#
		)
	</insert>
	<update id="jobDAO.update">
		UPDATE TN_JOB
		SET	BODY	= #body#,
			SUBURB	= #suburb#,
			PAY = #pay#, 
			ADDR = #addr#, 
			DUE_DATE = #dueDate#, 
			JOB_TYPE = #jobType#, 
			AD_TYPE = #adType#, 
			POS_X = #posX#,
			POS_Y = #posY#
		WHERE
			CONTENT_ID = #contentId#
	</update>
	
	<select id="jobDAO.select" resultClass="hashMap">
		SELECT C.*
			, J.BODY
			, J.POS_X
			, J.POS_Y
			, J.SUBURB 
			, J.PAY 
			, J.ADDR 
			, J.DUE_DATE 
			, J.JOB_TYPE
			, J.AD_TYPE
			, (SELECT COUNT(*) FROM TN_WATCH W WHERE W.CONTENT_ID = #contentId# AND W.USER_IDX = #userIdx# ) AS IS_WATCHED 
			, (SELECT USER_EMAIL FROM TN_USER_INFO U WHERE U.USER_IDX = C.USER_IDX) AS USER_EMAIL
		FROM TN_CONTENT C, TN_JOB J
		WHERE 
			J.CONTENT_ID = C.CONTENT_ID
			AND C.CONTENT_ID = #contentId#
			AND C.DEL_YN = 'N'
			AND C.STATE = 0
	</select>
</sqlMap>
