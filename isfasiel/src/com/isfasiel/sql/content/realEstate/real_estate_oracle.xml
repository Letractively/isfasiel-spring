<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="realEstate">
	<typeAlias alias="hashMap" type="java.util.HashMap"/>
	
	<select id="realEstateDAO.list" resultClass="hashMap">
		SELECT * FROM ( 
			SELECT A.*, ROWNUM RNUM FROM (
				SELECT 
					C.CONTENT_ID 
					,	C.TITLE 
					,	U.USER_EMAIL 
					,	C.VIEW_COUNT 
					,	C.CONTENT_TYPE
					,	(SELECT COUNT(*) 
							FROM TN_CNT_CMT CM 
							WHERE	
									CM.CONTENT_ID = C.CONTENT_ID 
								AND	CM.DEL_YN = 'N'
								AND	CM.STATE = 0)
						 AS CMT_COUNT
				FROM TN_CONTENT C, TN_USER_INFO U, TN_REAL_ESTATE R
				WHERE	R.CONTENT_ID = C.CONTENT_ID
						AND U.USER_IDX = C.USER_IDX
						AND C.DEL_YN = 'N'
					<isNotEmpty property="title" close="" open="" prepend="AND"> 
						TITLE LIKE '%' || #title# || '%' 
					</isNotEmpty>
					<isNotEmpty property="userEmail" close="" open="" prepend="AND"> 
						U.USER_EMAIL LIKE '%' || #userEmail# || '%' 
					</isNotEmpty>
					<isNotEmpty property="posMaxX" close="" open="" prepend="AND"> 
						R.POS_X &lt;= #posMaxX# AND R.POS_X &gt;= #posMinX#   
					</isNotEmpty>
					<isNotEmpty property="posMaxY" close="" open="" prepend="AND"> 
						R.POS_Y &lt;= #posMaxY# AND R.POS_Y &gt;= #posMinY#   
					</isNotEmpty>
					<isNotEmpty property="suburb" close="" open="" prepend="AND"> 
						 R.SUBURB LIKE '%' || #suburb# || '%'
					</isNotEmpty>
					<isNotEmpty property="price" close="" open="" prepend="AND"> 
						 R.PRICE <![CDATA[<=]]> (#price# + #priceTerm#) AND
						 R.PRICE <![CDATA[>=]]> (#price# - #priceTerm#)
					</isNotEmpty>
					<isNotEmpty property="addr" close="" open="" prepend="AND"> 
						 R.ADDR LIKE '%' || #addr# || '%'
					</isNotEmpty>
					<isNotEmpty property="availableDate" close="" open="" prepend="AND"> 
						 R.AVAILABLE_DATE = #availableDate#
					</isNotEmpty>
					<isNotEmpty property="roomType" close="" open="" prepend="AND"> 
						 R.ROOM_TYPE = #roomType#
					</isNotEmpty>
					<isNotEmpty property="smoking" close="" open="" prepend="AND"> 
						 R.SMOKING = #smoking# 
					</isNotEmpty>
					<isNotEmpty property="pets" close="" open="" prepend="AND"> 
						 R.PETS = #pets#
					</isNotEmpty>
					<isNotEmpty property="gender" close="" open="" prepend="AND"> 
						 R.GENDER = #gender#
					</isNotEmpty>
				ORDER BY C.CONTENT_ID DESC
			) A WHERE ROWNUM 
			<![CDATA[<=]]> #lastIndex# ) WHERE RNUM <![CDATA[>=]]> #firstIndex# 
	</select>
	<insert id="realEstateDAO.insert">
		INSERT INTO TN_REAL_ESTATE (
			CONTENT_ID,
			BODY,
			POS_X,
			POS_Y,
			SUBURB,
			PRICE, 
			ADDR, 
			AVAILABLE_DATE, 
			ROOM_TYPE, 
			SMOKING, 
			PETS, 
			GENDER
			) 
		VALUES ( 
			#contentId#,
			#body#,
			#posX#,
			#posY#,
			#suburb#,
			#price#,
			#addr#,
			#availableDate#,
			#roomType#,
			#smoking#,
			#pets#,
			#gender#
		)
	</insert>
	<update id="realEstateDAO.update">
		UPDATE TN_REAL_ESTATE
		SET	BODY	= #body#,
			SUBURB	= #suburb#,
			PRICE = #price#, 
			ADDR = #addr#, 
			AVAILABLE_DATE = #availableDate#, 
			ROOM_TYPE = #roomType#, 
			SMOKING = #smoking#, 
			PETS = #pets#, 
			GENDER = #gender#,
			POS_X = #posX#,
			POS_Y = #posY#
		WHERE
			CONTENT_ID = #contentId#
	</update>
	
	<select id="realEstateDAO.select" resultClass="hashMap">
		SELECT C.*
			, R.BODY
			, R.POS_X
			, R.POS_Y
			, R.SUBURB 
			, R.PRICE 
			, R.ADDR 
			, R.AVAILABLE_DATE 
			, R.ROOM_TYPE
			, R.SMOKING
			, R.PETS
			, R.GENDER
			, (SELECT COUNT(*) FROM TN_WATCH W WHERE W.CONTENT_ID = #contentId# AND W.USER_IDX = #userIdx# ) AS IS_WATCHED 
			, (SELECT USER_EMAIL FROM TN_USER_INFO U WHERE U.USER_IDX = C.USER_IDX) AS USER_EMAIL
		FROM TN_CONTENT C, TN_REAL_ESTATE R
		WHERE 
			R.CONTENT_ID = C.CONTENT_ID
			AND C.CONTENT_ID = #contentId#
			AND C.DEL_YN = 'N'
			AND C.STATE = 0
	</select>
</sqlMap>